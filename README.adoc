// Copyright (c) 2017 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//   IBM Corporation
:projectid: microprofile-opentracing
:page-layout: guide
:page-duration: 20 minutes
:page-releasedate: 2018-03-16
:page-description: Explore how to enable and customize tracing of JAX-RS and non-JAX-RS methods by using MicroProfile OpenTracing.
:page-tags: ['MicroProfile', 'OpenTracing', 'microservices', '@Traced']
:page-permalink: /guides/{projectid}
:page-related-guides: ['cdi-intro']
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/master
:source-highlighter: prettify
= Enabling distributed tracing in microservices

Explore how to enable and customize tracing of JAX-RS and non-JAX-RS methods by using MicroProfile OpenTracing.


:inv-url: http://localhost:9081/inventory/systems
:inv-url-docker: http://localhost:9080/inventory/systems
:sys-url: http://localhost:9080/system/properties
:zipkin-url: http://localhost:9411


== What you'll learn

You will learn how to enable automatic tracing for JAX-RS methods as well as create custom tracers
for non-JAX-RS methods by using MicroProfile OpenTracing.

OpenTracing is a standard API for instrumenting microservices for distributed tracing. Distributed
tracing helps troubleshoot microservices by examining and logging requests as they propagate through a
distributed system, allowing developers to tackle the otherwise difficult task of debugging these requests.
Without a distributed tracing system in place, analyzing the workflows of operations becomes difficult,
particularly in regard to pinpointing when and by whom a request is received, as well as when a response
is sent back.

MicroProfile OpenTracing enables distributed tracing in microservices without adding any explicit
distributed tracing code to the application. Note that the MicroProfile OpenTracing specification does
not address the problem of defining, implementing, or configuring the underlying distributed tracing
system. Rather, the specification makes it easy to instrument services with distributed tracing given
an existing distributed tracing system.

You will configure the provided `inventory` and `system` services to use distributed tracing with
MicroProfile OpenTracing. You will run these services in two separate JVMs made of two server instances
to demonstrate tracing in a distributed environment. If all the components were to run on a single
server, then any logging software would do the trick.


// =================================================================================================
// Getting Started
// =================================================================================================

include::{common-includes}/gitclone.adoc[]


For this guide, use Zipkin as your distributed tracing system. You can find the installation instructions
for Zipkin at the Zipkin https://zipkin.io/pages/quickstart.html[quickstart page]. You are not required
to use Zipkin, but keep in mind that you might need more instructions that are not listed here if you choose
to use another tracing system.

Before you proceed, make sure that your Zipkin server is up and running. By default, Zipkin can be found
at the {zipkin-url} URL.


=== Try what you'll build

The `finish` directory in the root directory of this guide contains two services that are configured
to use MicroProfile OpenTracing. Feel free to give them a try before you proceed.

To try out the services, navigate to the `finish` directory and then run the Maven `install` and
`liberty:start-server` goals to build the services and run them in two Open Liberty servers:

```
cd finish
mvn install
mvn liberty:start-server
```

Make sure that your Zipkin server is running and point your browser to the {inv-url}/localhost URL. When you visit
this endpoint, you make two GET HTTP requests, one to the `system` service and one to the `inventory`
service. Both of these requests are configured to be traced, so a new trace will be recorded in Zipkin.
Visit the {zipkin-url} URL or another location where you configured Zipkin to run. Verify that this
new trace contains four spans with the following names:

- `get:io.openliberty.guides.inventory.inventoryresource.getpropertiesforhost`
- `get`
- `get:io.openliberty.guides.system.systemresource.getproperties`
- `addtoinventory() span`

// image::/guides/draft-guide-microprofile-opentracing/resources/disable-tracing.png[png][Disable tracing, width=100%]

You can inspect each span by clicking it to reveal more detailed information, such as the time
at which the request was received and the time at which a response was sent back.

If you examine the other traces, you might notice a red trace entry, which happens when an error is
caught by the span. In this case, since one of the tests accesses the `/inventory/systems/badhostname`
endpoint, which is invalid, an error is thrown. This behavior is expected.

When you are done checking out the services, stop both Open Liberty servers using the Maven
`liberty:stop-server` goal:

```
mvn liberty:stop-server
```

// =================================================================================================
// Running the application with Docker
// =================================================================================================

// == Running the services
//
// Before you begin, you must build and run the `inventory` and `system` services. You must also start
// your Zipkin server (or another tracing system of your choice). You have two options for doing this:
//
// - Running everything inside Docker containers
// - Running the two services outside of Docker in two separate Open Liberty servers
//
//
// === Running with Docker
//
// *THIS DOES NOT WORK AS OF MARCH 2, 2018 BECAUSE IT REQUIRES OL 18.0.0.1 WHICH IS NOT A PART OF ANY DOCKER IMAGE*
//
// If you are using Docker to run your Zipkin server and you would prefer running your services with Docker
// as well, then follow these instructions:
//
// A `Dockerfile` and a `docker-compose.yaml` are provided under the `docker` directory in the root directory
// of this guide. Navigate to this directory and build your services:
//
// ```
// cd docker
// mvn package
// ```
//
// Stop your Zipkin container if you have previously started it, then run the following command:
//
// ```
// docker-compose up -d
// ```
//
// This command picks up the `Dockerfile` and the `docker-compose.yaml` and builds a Docker image containing
// the Open Liberty runtime. Three containers are also built and started alongside the image: one for the
// `system` service, one for the `inventory` service, and one for the Zipkin server.
//
// Once the containers are running, the `inventory` service can be reached at {inv-url-docker} and the Zipkin server at
// {zipkin-url}. To retrieve the JVM system properties of the container running the `system` service, point
// to {inv-url-docker}/sys (all containers are linked and therefore they can access each other by their container names).
//
// Feel free to read our https://openliberty.io/guides/docker.html[Docker guide] to learn more about developing
// applications with Open Liberty and Docker.
//
//
// === Running the services outside of Docker
//
// Navigate to the `start` directory, then build the services and run them in Open Liberty:
//
// ```
// cd start
// mvn install liberty:start-server
// ```
//
// You can find the `inventory` and `system` services at:
//
// - {inv-url}
// - {sys-url}
//
// include::{common-includes}/mvncompile.adoc[]


// =================================================================================================
// Running the services
// =================================================================================================

== Running the services

You'll need to start the services to see basic traces appear in Zipkin. So, before you proceed, build
and start the provided `system` and `inventory` services in the starting project. Navigate to the `start`
directory and run the Maven `install` and `liberty:start-server` goals:

```
mvn install
mvn liberty:start-server
```

When the servers start, you can find the `system` and `inventory` services at the following URLs:

- {sys-url}
- {inv-url}


include::{common-includes}/mvnpackage.adoc[]


// =================================================================================================
// Existing Tracer implementation
// =================================================================================================

== Existing Tracer implementation

To collect traces across your systems, you need to implement the OpenTracing `Tracer`
interface. For this guide, you can access a bare-bones `Tracer` implementation for
the Zipkin server in the form of a user feature for Open Liberty.

This feature is already configured for you in your `pom.xml` and `server.xml` files. It will be
downloaded and installed automatically into each service when you run a Maven build. You can find it
enabled in your `server.xml` files:

[source, xml, role="no_copy"]
----
<feature>usr:opentracingZipkin-0.30</feature>
----

The following Maven plug-in is responsible for downloading and installing the feature:

[source, xml, role="no_copy"]
----
<groupId>com.googlecode.maven-download-plugin</groupId>
<artifactId>download-maven-plugin</artifactId>
<version>${version.download-maven-plugin}</version>
<executions>
    <execution>
        <id>install-tracer</id>
        <phase>prepare-package</phase>
        <goals>
            <goal>wget</goal>
        </goals>
        <configuration>
            <url>https://repo1.maven.org/maven2/net/wasdev/wlp/tracer/liberty-opentracing-zipkintracer/1.0/liberty-opentracing-zipkintracer-1.0-sample.zip</url>
            <unpack>true</unpack>
            <outputDirectory>${project.build.directory}/liberty/wlp/usr</outputDirectory>
        </configuration>
    </execution>
</executions>
</plugin>
----

If you want to install this feature yourself, see
https://www.ibm.com/support/knowledgecenter/was_beta/com.ibm.websphere.wlp.nd.multiplatform.doc/ae/twlp_dist_tracing.html[Enabling distributed tracing]
in the IBM Knowledge Centre.


// =================================================================================================
// Enabling distributed tracing
// =================================================================================================

== Enabling distributed tracing

The `mpOpenTracing-1.0` MicroProfile OpenTracing feature enables tracing of all JAX-RS methods by default.
To further control and customize these traces, use the `@Traced` annotation to enable and disable
tracing of particular methods. You can also inject a custom `Tracer` object to create and customize spans.


=== Enabling distributed tracing without code instrumentation

Because tracing of all JAX-RS methods is enabled by default, you need only to enable MicroProfile
OpenTracing and the Zipkin user feature in the `server.xml` file to see some basic traces in Zipkin.

Both of these features are already enabled in the `inventory/src/main/liberty/config/server.xml`
and `system/src/main/liberty/config/server.xml` files:

[source, xml, role="no_copy"]
----
<feature>mpOpenTracing-1.0</feature>
<feature>usr:opentracingZipkin-0.30</feature>
----

Make sure that your services are running. Then, simply point your browser to any of their endpoints and
check your Zipkin server for traces.


=== Enabling explicit distributed tracing

Use the `@Traced` annotation to define explicit span creation for specific classes and methods.
If you place the annotation on a class, then it's automatically applied to all methods within that class.
If you place the annotation on a method, then it overrides the class annotation if one exists.

The `@Traced` annotation can be configured with the following two parameters:

- The `value=[true|false]` parameter indicates whether or not a particular class or method is
traced. For example, while all JAX-RS methods are traced by default, you can disable their tracing by
using the `@Traced(false)` annotation. This parameter is set to `true` by default.
- The `operationName=<Span name>` parameter indicates the name of the span that is assigned to the
particular method that is traced. If you omit this parameter, the span will be named with the following
form: `<package name>.<class name>.<method name>`. If you use this parameter at a class level, then
all methods within that class will have the same span name unless they are explicitly overridden by
another `@Traced` annotation.

Enable tracing of the `list()` non-JAX-RS method in the `inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java` file:

[source, Java]
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java[tags=**;!copyright;!custom-tracer;addToInvList]
----

Next, run the `mvn package` command from the `start` directory to rebuild your services. Point to the
{inv-url} URL and check your Zipkin server. You see a new trace record that is two spans long with
one span for the `listContents()` JAX-RS method in the `InventoryResource` class and another span for
the `list()` method in the `InventoryManager` class. Verify that these spans have the following names:

- `get:io.openliberty.guides.inventory.inventoryresource.listcontents`
- `inventorymanger.list`

// image::/guides/draft-guide-microprofile-opentracing/resources/enable-tracing.png[png][Enable tracing, width=100%]

Now, disable tracing of the `listContents()` JAX-RS method in the `inventory/src/main/java/io/openliberty/guides/inventory/InventoryResource.java` file:

[source, Java]
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryResource.java[tags=**;!copyright]
----

Again, run the `mvn package` command from the `start` directory to rebuild your services. Point to the
{inv-url} URL and check your Zipkin server. You see a new trace record that is just one span long for
the remaining `list()` method in the `InventoryManager` class. Verify that this span has the following name:

- `inventorymanger.list`

// image::/guides/draft-guide-microprofile-opentracing/resources/disable-tracing.png[png][Disable tracing, width=100%]


=== Injecting a custom Tracer object

The MicroProfile OpenTracing specification also makes the underlying OpenTracing `Tracer` instance
available for use. You can access the configured `Tracer` by injecting it into a bean by using the `@Inject`
annotation from the Contexts and Dependency Injections API.

Inject the `Tracer` object into the `inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java` file.
Then, use it to define a new child span in the `get()` method around the `addToInventoryList()` call:

[source, Java]
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java[tags=**;!copyright]
----

The `try` block that you see here is called a `try-with-resources` statement, meaning that the `childSpan`
object is closed at the end of the statement. It's good practice to define custom spans inside
such statements. Otherwise, any exceptions that are thrown before the span is closed will leak the active span.

Next, run the `mvn package` command from the `start` directory to rebuild your services. Point to the
{inv-url}/localhost URL and check your Zipkin server. You see a new trace record that is four spans long
with the first two spans for the `getPropertiesForHost()` method in the `InventoryResource` class and
the third span for the `getProperties()` method in the `SystemResource` class. The last span is the
custom span that you created around the `addToInventoryList()` call. Verify that these spans have the
following names:

- `get:io.openliberty.guides.inventory.inventoryresource.getpropertiesforhost`
- `get`
- `get:io.openliberty.guides.system.systemresource.getproperties`
- `addtoinventory() span`

// image::/guides/draft-guide-microprofile-opentracing/resources/inject-tracer.png[png][Inject tracer, width=100%]

This simple example shows what you can do with the injected `Tracer` object. More configuration
options are available to you, including setting a timestamp for when a span was created and destroyed.
However, these options require an implementation of their own, which does not come as a part of the Zipkin
user feature that is provided. In a real-world scenario, implement all the OpenTracing interfaces that
you deem necessary, which might include the `SpanBuilder` interface. You can use this interface for span
creation and customization, including setting timestamps.


// =================================================================================================
// Testing the services
// =================================================================================================

== Testing the services

No automated tests are provided to verify the correctness of the traces. Manually verify these traces
by viewing them on the Zipkin server.

A few tests are included for you to test the basic functionality of the services. If a test failure
occurs, then you might have introduced a bug into the code. These tests will run automatically as a
part of the Maven build process when you run the `mvn install` command. You can also run these tests
separately from the build by using the `mvn verify` command, but first make sure that the servers are
stopped.


// =================================================================================================
// Great work! You're done!
// =================================================================================================

== Great work! You're done!

You have just used MicroProfile OpenTracing to customize how and which traces are delivered to Zipkin.

Feel free to try one of the related MicroProfile guides. They demonstrate additional technologies that you
can learn to expand on top of what you built here.

include::{common-includes}/finish.adoc[]
